<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Satisfactory 資源・中間素材 総合計算機 (拡張版)</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            background: #1a1a1a;
            color: #eee;
            padding: 20px;
        }

        .container {
            max-width: 1250px;
            margin: auto;
            background: #2d2d2d;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #444;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: #383838;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #fa9549;
        }

        .input-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .input-item span {
            font-size: 0.9em;
            flex: 1;
        }

        input,
        select {
            background: #111;
            color: #fa9549;
            border: 1px solid #555;
            padding: 6px;
            border-radius: 4px;
            width: 80px;
            text-align: right;
        }

        select#target_id,
        select.recipe-select {
            width: 100%;
            text-align: left;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        button {
            background: #fa9549;
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            flex: 2;
        }

        #recipe-toggle-btn {
            background: #555;
            color: white;
            flex: 1;
        }

        #recipe-panel {
            display: none;
            background: #111;
            border: 1px solid #fa9549;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #fa9549;
            padding-bottom: 5px;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
        }

        .recipe-item {
            border-bottom: 1px solid #333;
            padding: 5px;
        }

        .recipe-name {
            color: #fa9549;
            font-weight: bold;
        }

        .results {
            display: grid;
            grid-template-columns: 1fr 1.8fr;
            gap: 20px;
            margin-top: 20px;
        }

        .result-box {
            background: #111;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            height: 550px;
            overflow-y: auto;
            line-height: 1.5;
        }

        h3 {
            color: #fa9549;
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .scroll-area {
            height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Satisfactory 資源・中間素材 総合計算機</h1>

        <div class="input-grid">
            <div class="card">
                <h3>1. 原材料供給 (個/分)</h3>
                <div class="input-item"><span>鉄鉱石</span><input type="number" id="in_iron" value="0"></div>
                <div class="input-item"><span>銅鉱石</span><input type="number" id="in_copper" value="0"></div>
                <div class="input-item"><span>石炭</span><input type="number" id="in_coal" value="0"></div>
                <div class="input-item"><span>石灰岩</span><input type="number" id="in_limestone" value="0"></div>
            </div>
            <div class="card">
                <h3>2. 中間素材の持ち込み (個/分)</h3>
                <div class="scroll-area" id="intermediate-inputs"></div>
            </div>
            <div class="card">
                <h3>3. 目標アイテム & レシピ</h3>
                <select id="target_id"></select>
                <div style="margin-top:10px; font-size:0.8em;">
                    強化鉄板: <select id="recipe_reinforced_plate" class="recipe-select">
                        <option value="reinforced_plate_normal">通常（鉄板+ネジ）</option>
                        <option value="reinforced_plate_stitched">編み上げ（鉄板+ワイヤー）</option>
                        <option value="reinforced_plate_bolted">ボルト（鉄板+ネジ・生産増）</option>
                    </select>
                    ワイヤー: <select id="recipe_wire" class="recipe-select">
                        <option value="wire_normal">通常（銅インゴット）</option>
                        <option value="wire_iron">鉄のワイヤー（鉄インゴット）</option>
                    </select>
                    ローター: <select id="recipe_rotor" class="recipe-select">
                        <option value="rotor_normal">通常（鉄棒+ネジ）</option>
                        <option value="rotor_copper">銅のローター（銅板+ネジ）</option>
                    </select>
                    ネジ: <select id="recipe_screw" class="recipe-select">
                        <option value="screw_normal">通常（鉄棒）</option>
                        <option value="screw_cast">鋳造（鉄インゴット）</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <button id="recipe-toggle-btn" onclick="toggleRecipePanel()">レシピ一覧を表示</button>
            <button onclick="calculate()">計算実行</button>
        </div>

        <div id="recipe-panel">
            <div class="recipe-header">
                <h3 style="margin:0;">マスターレシピ一覧</h3>
                <input type="text" id="recipe-search" placeholder="アイテム名で検索..." onkeyup="renderRecipeList()"
                    style="width: 250px; text-align: left; padding: 5px;">
            </div>
            <div id="recipe-content" class="recipe-grid"></div>
        </div>

        <div class="results">
            <div>
                <h3>生産サマリー</h3>
                <div id="summary" class="result-box"></div>
            </div>
            <div>
                <h3>工程別詳細 (必要マシン数・消費内訳)</h3>
                <div id="flows" class="result-box"></div>
            </div>
        </div>
    </div>

    <script>
        const nameMap = {
            in_iron: "鉄鉱石", in_copper: "銅鉱石", in_coal: "石炭", in_limestone: "石灰岩",
            iron_ingot: "鉄インゴット", copper_ingot: "銅インゴット", steel_ingot: "鋼鉄インゴット",
            iron_plate: "鉄板", copper_plate: "銅板", iron_rod: "鉄の棒", screw: "ネジ", wire: "ワイヤー", cable: "ケーブル", concrete: "コンクリート",
            reinforced_plate: "強化鉄板", rotor: "ローター", stator: "固定子", motor: "モーター",
            steel_beam: "鋼梁", steel_pipe: "鋼管", encased_beam: "被覆鋼梁", modular_frame: "モジュラーフレーム",
            smart_plate: "スマートプレート", versatile_framework: "多目的フレーム", automated_wiring: "自動ワイヤー"
        };

        const recipes = {
            iron_ingot: { in: { in_iron: 1 }, out: 1, outRate: 30 },
            copper_ingot: { in: { in_copper: 1 }, out: 1, outRate: 30 },
            steel_ingot: { in: { in_iron: 3, in_coal: 3 }, out: 3, outRate: 45 },
            iron_plate: { in: { iron_ingot: 3 }, out: 2, outRate: 20 },
            copper_plate: { in: { copper_ingot: 2 }, out: 1, outRate: 10 },
            iron_rod: { in: { iron_ingot: 1 }, out: 1, outRate: 15 },
            screw_normal: { result: "screw", in: { iron_rod: 1 }, out: 4, outRate: 40 },
            screw_cast: { result: "screw", in: { iron_ingot: 1 }, out: 4, outRate: 40 },
            wire_normal: { result: "wire", in: { copper_ingot: 1 }, out: 2, outRate: 30 },
            wire_iron: { result: "wire", in: { iron_ingot: 25 }, out: 45, outRate: 22.5 },
            cable: { in: { wire: 2 }, out: 1, outRate: 30 },
            concrete: { in: { in_limestone: 3 }, out: 1, outRate: 15 },
            reinforced_plate_normal: { result: "reinforced_plate", in: { iron_plate: 6, screw: 12 }, out: 1, outRate: 5 },
            reinforced_plate_stitched: { result: "reinforced_plate", in: { iron_plate: 18.75, wire: 37.5 }, out: 5.625, outRate: 5.625 },
            reinforced_plate_bolted: { result: "reinforced_plate", in: { iron_plate: 18, screw: 50 }, out: 3, outRate: 15 },
            rotor_normal: { result: "rotor", in: { iron_rod: 5, screw: 25 }, out: 1, outRate: 4 },
            rotor_copper: { result: "rotor", in: { copper_plate: 6, screw: 52 }, out: 3, outRate: 11.25 },
            stator: { in: { steel_pipe: 3, wire: 15 }, out: 1, outRate: 5 },
            steel_beam: { in: { steel_ingot: 4 }, out: 1, outRate: 15 },
            steel_pipe: { in: { steel_ingot: 3 }, out: 2, outRate: 20 },
            encased_beam: { in: { steel_beam: 6, concrete: 8 }, out: 1, outRate: 6 },
            motor: { in: { rotor: 2, stator: 2 }, out: 1, outRate: 5 },
            modular_frame: { in: { reinforced_plate: 3, iron_rod: 12 }, out: 2, outRate: 2 },
            smart_plate: { in: { reinforced_plate: 1, rotor: 1 }, out: 2, outRate: 2 },
            versatile_framework: { in: { modular_frame: 1, steel_beam: 12 }, out: 2, outRate: 2 },
            automated_wiring: { in: { stator: 1, cable: 20 }, out: 1, outRate: 2.5 }
        };

        const intermediateItems = ["iron_ingot", "copper_ingot", "steel_ingot", "iron_plate", "copper_plate", "iron_rod", "screw", "wire", "cable", "concrete", "reinforced_plate", "rotor", "stator", "steel_beam", "steel_pipe", "encased_beam"];

        // UI初期化
        const interDiv = document.getElementById('intermediate-inputs');
        intermediateItems.forEach(id => {
            interDiv.innerHTML += `<div class="input-item"><span>${nameMap[id]}</span><input type="number" id="add_${id}" value="0"></div>`;
        });

        const targetSelect = document.getElementById('target_id');
        Object.keys(nameMap).filter(id => !id.startsWith('in_')).forEach(id => {
            const opt = document.createElement('option'); opt.value = id; opt.textContent = nameMap[id];
            if (id === "modular_frame") opt.selected = true; targetSelect.appendChild(opt);
        });

        function toggleRecipePanel() {
            const panel = document.getElementById('recipe-panel');
            const btn = document.getElementById('recipe-toggle-btn');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block'; btn.innerText = 'レシピ一覧を閉じる'; renderRecipeList();
            } else { panel.style.display = 'none'; btn.innerText = 'レシピ一覧を表示'; }
        }

        function renderRecipeList() {
            const content = document.getElementById('recipe-content');
            const searchTerm = document.getElementById('recipe-search').value.toLowerCase();
            content.innerHTML = '';
            Object.keys(recipes).sort().forEach(id => {
                const r = recipes[id];
                let displayName = nameMap[id] || nameMap[r.result] || id;
                if (id.includes('stitched')) displayName += ' (編み上げ)';
                if (id.includes('bolted')) displayName += ' (ボルト)';
                if (id.includes('iron')) displayName += ' (鉄代替)';
                if (id.includes('copper')) displayName += ' (銅代替)';
                if (id.includes('cast')) displayName += ' (鋳造)';

                if (!displayName.toLowerCase().includes(searchTerm)) return;

                let inText = Object.entries(r.in).map(([mat, qty]) => {
                    const perMinute = (qty / r.out * r.outRate).toFixed(2);
                    return `${nameMap[mat] || mat}: ${perMinute}/分`;
                }).join('<br>　 ');

                content.innerHTML += `
                    <div class="recipe-item">
                        <div class="recipe-name">${displayName}</div>
                        <div style="font-size: 0.9em; margin-left: 10px;">
                            <strong>【1台あたりの消費量】</strong><br>
                            　 ${inText}
                        </div>
                        <div style="font-size: 0.9em; margin-left: 10px; color: #00ffcc;">
                            <strong>【1台あたりの生産量】</strong><br>
                            　 ${displayName}: ${r.outRate}/分
                        </div>
                    </div>
                `;
            });
            if (content.innerHTML === '') content.innerHTML = '<div style="color: #888; padding: 20px;">一致するレシピが見つかりません。</div>';
        }

        function getActiveRecipeId(itemId) {
            if (itemId === "screw") return document.getElementById('recipe_screw').value;
            if (itemId === "reinforced_plate") return document.getElementById('recipe_reinforced_plate').value;
            if (itemId === "wire") return document.getElementById('recipe_wire').value;
            if (itemId === "rotor") return document.getElementById('recipe_rotor').value;
            return itemId;
        }

        function solve(targetId, targetAmt, supply) {
            let totalNeeded = { in_iron: 0, in_copper: 0, in_coal: 0, in_limestone: 0 };
            let productionFlow = {};
            function process(id, amt) {
                if (amt <= 0.0001) return;
                let fromSupply = Math.min(amt, supply[id] || 0);
                amt -= fromSupply; supply[id] -= fromSupply;
                if (amt <= 0.0001) return;
                const rid = getActiveRecipeId(id); const recipe = recipes[rid];
                if (!recipe) { if (totalNeeded.hasOwnProperty(id)) totalNeeded[id] += amt; return; }
                productionFlow[rid] = (productionFlow[rid] || 0) + amt;
                for (let [cin, cqty] of Object.entries(recipe.in)) { process(cin, (cqty / recipe.out) * amt); }
            }
            process(targetId, targetAmt);
            return { totalNeeded, productionFlow };
        }

        function calculate() {
            const supplyLimit = {
                in_iron: parseFloat(document.getElementById('in_iron').value) || 0, in_copper: parseFloat(document.getElementById('in_copper').value) || 0,
                in_coal: parseFloat(document.getElementById('in_coal').value) || 0, in_limestone: parseFloat(document.getElementById('in_limestone').value) || 0
            };
            const initialStock = {}; intermediateItems.forEach(id => { initialStock[id] = parseFloat(document.getElementById(`add_${id}`).value) || 0; });
            const targetId = document.getElementById('target_id').value;
            let low = 0, high = 10000;
            for (let i = 0; i < 40; i++) {
                let mid = (low + high) / 2; let testStock = { ...initialStock }; let res = solve(targetId, mid, testStock);
                let ok = true; for (let [rawId, req] of Object.entries(res.totalNeeded)) { if (req > (supplyLimit[rawId] || 0)) { ok = false; break; } }
                if (ok) low = mid; else high = mid;
            }
            const finalAmt = low; const finalRes = solve(targetId, finalAmt, { ...initialStock });

            let summaryHtml = `【最終生産】\n${nameMap[targetId]}: ${finalAmt.toFixed(2)} /分\n\n【余剰資源・素材分析】\n------------------\n`;
            for (let [resId, limit] of Object.entries(supplyLimit)) {
                let used = finalRes.totalNeeded[resId] || 0; let diff = limit - used;
                summaryHtml += `${nameMap[resId].padEnd(6)} : ${diff < 0.01 ? "★ボトルネック" : "余り " + diff.toFixed(2) + "/分"}\n`;
            }
            document.getElementById('summary').innerText = summaryHtml;

            let flowsText = `【工程詳細 ＆ マシン1台あたりの消費量】\n`;
            flowsText += `--------------------------------------------------\n`;
            Object.keys(finalRes.productionFlow).sort().forEach(rid => {
                const amt = finalRes.productionFlow[rid];
                const recipe = recipes[rid];
                const machineCount = (amt / recipe.outRate).toFixed(2);
                let name = nameMap[rid] || nameMap[recipe.result] || rid;
                if (rid.includes('stitched')) name += ' (編み上げ)';
                if (rid.includes('bolted')) name += ' (ボルト)';
                if (rid.includes('iron')) name += ' (鉄代替)';
                if (rid.includes('copper')) name += ' (銅代替)';
                if (rid.includes('cast')) name += ' (鋳造)';

                flowsText += `■ ${name.padEnd(12)}: ${amt.toFixed(2).padStart(8)} /分 (${machineCount} 台)\n`;
                for (let [min, mqty] of Object.entries(recipe.in)) {
                    const totalCons = (mqty / recipe.out * amt).toFixed(2);
                    const perMachine = (mqty / recipe.out * recipe.outRate).toFixed(2);
                    flowsText += `   ┗材料: ${nameMap[min].padEnd(10)} -> ${totalCons.padStart(8)} /分 (1台につき ${perMachine.padStart(5)} /分)\n`;
                }
                flowsText += `\n`;
            });
            document.getElementById('flows').innerText = flowsText;
        }
    </script>
</body>

</html>

